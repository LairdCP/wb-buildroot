From 5ecc2bbe9a5e19c9505bd3306f3098112aecf237 Mon Sep 17 00:00:00 2001
From: Steve deRosier <Steve.Derosier@lairdtech.com>
Date: Mon, 20 May 2013 09:51:38 -0700
Subject: [PATCH 1/5] Basic configuration patches origionally from svn tree

---
 Config.in                                         |    2 +-
 board/at91sam9x5ek/at91sam9x5ek.c                 |   17 +++++++++--------
 board/at91sam9x5ek/at91sam9x5eknf_uboot_defconfig |   14 +++++++-------
 driver/nandflash.c                                |    6 +++---
 4 files changed, 20 insertions(+), 19 deletions(-)

diff --git a/Config.in b/Config.in
index 0b7f740..0026260 100644
--- a/Config.in
+++ b/Config.in
@@ -149,7 +149,7 @@ config CONFIG_IMG_SIZE
 config CONFIG_JUMP_ADDR
 	string "The External Ram Address to Load U-Boot Image"
 	default "0x73F00000" if CONFIG_AT91SAM9M10G45EK
-	default "0x26F00000" if CONFIG_AT91SAM9X5EK || CONFIG_AT91SAM9N12EK || CONFIG_AT91SAMA5D3XEK
+	default "0x23F00000" if CONFIG_AT91SAM9X5EK || CONFIG_AT91SAM9N12EK || CONFIG_AT91SAMA5D3XEK
 	default "0x21F00000" if CONFIG_AT91SAM9260EK || CONFIG_AT91SAM9261EK || CONFIG_AT91SAM9263EK || CONFIG_AT91SAM9G10EK || CONFIG_AT91SAM9G20EK || CONFIG_AT91SAM9RLEK
 	default "0x23F00000"
 	help
diff --git a/board/at91sam9x5ek/at91sam9x5ek.c b/board/at91sam9x5ek/at91sam9x5ek.c
index e1913c1..03227e3 100644
--- a/board/at91sam9x5ek/at91sam9x5ek.c
+++ b/board/at91sam9x5ek/at91sam9x5ek.c
@@ -75,12 +75,12 @@ static void initialize_dbgu(void)
 static void ddramc_reg_config(struct ddramc_register *ddramc_config)
 {
 	ddramc_config->mdr = (AT91C_DDRC2_DBW_16_BITS
-			| AT91C_DDRC2_MD_DDR2_SDRAM);
+			| AT91C_DDRC2_MD_LP_DDR_SDRAM);
 
 	ddramc_config->cr = (AT91C_DDRC2_NC_DDR10_SDR9 /* 10 column bits(1K) */
 			| AT91C_DDRC2_NR_13              /* 13 row bits (8K) */
 			| AT91C_DDRC2_CAS_3              /* CAS Latency 3 */
-			| AT91C_DDRC2_NB_BANKS_8         /* 8 banks */
+			| AT91C_DDRC2_NB_BANKS_4         /* 4 banks */
 			| AT91C_DDRC2_DLL_RESET_DISABLED /* DLL not reset */
 			| AT91C_DDRC2_DECOD_INTERLEAVED);/*Interleaved decode*/
 
@@ -256,15 +256,16 @@ void nandflash_hw_init(void)
 		{"NANDALE",	CONFIG_SYS_NAND_ALE_PIN,	0, PIO_PULLUP, PIO_PERIPH_A},
 		{"NANDCLE",	CONFIG_SYS_NAND_CLE_PIN,	0, PIO_PULLUP, PIO_PERIPH_A},
 		{"NANDCS", 	CONFIG_SYS_NAND_ENABLE_PIN,	1, PIO_PULLUP, PIO_OUTPUT},
+		{"NWP", AT91C_PIN_PD(10), 1, PIO_PULLUP, PIO_OUTPUT},
 		{(char *)0,	0, 0, PIO_DEFAULT, PIO_PERIPH_A},
 	};
 
 	reg = readl(AT91C_BASE_CCFG + CCFG_EBICSA);
 	reg |= AT91C_EBI_CS3A_SM;
-	if ((get_cm_rev() == 'A') && (get_cm_vendor() == VENDOR_EMBEST))
+//	if ((get_cm_rev() == 'A') && (get_cm_vendor() == VENDOR_EMBEST))
 		reg &= ~AT91C_EBI_NFD0_ON_D16;
-	else
-		reg |= (AT91C_EBI_DDR_MP_EN | AT91C_EBI_NFD0_ON_D16);
+//	else
+//		reg |= (AT91C_EBI_DDR_MP_EN | AT91C_EBI_NFD0_ON_D16);
 
 	reg &= ~AT91C_EBI_DRV;
 	writel(reg, AT91C_BASE_CCFG + CCFG_EBICSA);
@@ -294,10 +295,10 @@ void nandflash_hw_init(void)
 		AT91C_BASE_SMC + SMC_CTRL3);
 
 	/* Configure the PIO controller */
-	if ((get_cm_rev() == 'A') && (get_cm_vendor() == VENDOR_EMBEST))
+//	if ((get_cm_rev() == 'A') && (get_cm_vendor() == VENDOR_EMBEST))
 		pio_configure(nand_pins_lo);
-	else
-		pio_configure(nand_pins_hi);
+//	else
+//		pio_configure(nand_pins_hi);
 
 	writel((1 << AT91C_ID_PIOC_D), (PMC_PCER + AT91C_BASE_PMC));
 }
diff --git a/board/at91sam9x5ek/at91sam9x5eknf_uboot_defconfig b/board/at91sam9x5ek/at91sam9x5eknf_uboot_defconfig
index 6049228..c667c10 100644
--- a/board/at91sam9x5ek/at91sam9x5eknf_uboot_defconfig
+++ b/board/at91sam9x5ek/at91sam9x5eknf_uboot_defconfig
@@ -1,6 +1,6 @@
 #
 # Automatically generated make config: don't edit
-# Mon Aug 13 14:17:39 2012
+# Sat Oct 27 12:03:11 2012
 #
 HAVE_DOT_CONFIG=y
 CONFIG_BOARDNAME="at91sam9x5ek"
@@ -57,8 +57,8 @@ ALLOW_HSMCI=y
 # ALLOW_PSRAM is not set
 # ALLOW_SDRAM_16BIT is not set
 # CONFIG_RAM_32MB is not set
-# CONFIG_RAM_64MB is not set
-CONFIG_RAM_128MB=y
+CONFIG_RAM_64MB=y
+# CONFIG_RAM_128MB is not set
 # CONFIG_RAM_256MB is not set
 # CONFIG_RAM_512MB is not set
 # CONFIG_DATAFLASH is not set
@@ -84,9 +84,9 @@ CONFIG_LOAD_UBOOT=y
 # CONFIG_LOAD_1MB is not set
 # CONFIG_LOAD_4MB is not set
 # CONFIG_LOAD_64KB is not set
-CONFIG_IMG_ADDRESS="0x00040000"
+CONFIG_IMG_ADDRESS="0x00020000"
 CONFIG_IMG_SIZE="0x00080000"
-CONFIG_JUMP_ADDR="0x26F00000"
+CONFIG_JUMP_ADDR="0x23f00000"
 
 #
 # U-Boot Image Storage Setup
@@ -94,9 +94,9 @@ CONFIG_JUMP_ADDR="0x26F00000"
 CONFIG_IMAGE_NAME="uboot"
 # CONFIG_LONG_TEST is not set
 CONFIG_DEBUG=y
-CONFIG_DEBUG_INFO=y
+# CONFIG_DEBUG_INFO is not set
 # CONFIG_DEBUG_LOUD is not set
-# CONFIG_DEBUG_VERY_LOUD is not set
+CONFIG_DEBUG_VERY_LOUD=y
 CONFIG_HW_INIT=y
 # CONFIG_USER_HW_INIT is not set
 CONFIG_THUMB=y
diff --git a/driver/nandflash.c b/driver/nandflash.c
index 3054408..d50b4a3 100644
--- a/driver/nandflash.c
+++ b/driver/nandflash.c
@@ -200,11 +200,11 @@ static void config_nand_ooblayout(struct nand_ooblayout *layout, struct nand_chi
 		layout->badblockpos = 0;
 		oobsize = chip->oobsize;
 #ifdef CONFIG_USE_PMECC
-		layout->eccbytes = 16;
+		layout->eccbytes = 28;
 #else
 		layout->eccbytes = 24;
 #endif
-		layout->oobavail_offset = 1;
+		layout->oobavail_offset = 30;
 		break;
 
 	case 4096:
@@ -504,7 +504,7 @@ static int nandflash_get_type(struct nand_info *nand)
 static int init_pmecc_descripter(struct _PMECC_paramDesc_struct *pmecc_params, struct nand_info *nand)
 {
 	if ((nand->pagesize == 2048) || (nand->pagesize == 4096)) {
-		pmecc_params->errBitNbrCapability = AT91C_PMECC_BCH_ERR2; 	/* Error Correct Capability */
+		pmecc_params->errBitNbrCapability = AT91C_PMECC_BCH_ERR4; 	/* Error Correct Capability */
 		pmecc_params->sectorSize = AT91C_PMECC_SECTORSZ_512;		/* Sector Size */
 		pmecc_params->nandWR = AT91C_PMECC_NANDWR_0;			/* NAND read access */
 		pmecc_params->spareEna = AT91C_PMECC_SPAREENA_DIS;		/* for NAND read access,the spare area is skipped  */
-- 
1.7.9.5

